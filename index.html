<!DOCTYPE html>

<script type="module">
	let WASM_MODULE;

	function c_to_js(mem, ptr, len) {
		const view = new Uint8Array(mem, ptr);
		let str = '';

		for (let x = 0; x < len; x++) {
			if (view[x] == 0)
				break;

			str += String.fromCharCode(view[x]);
		}

		return str;
	}

	function mem() {
		return new DataView(WASM_MODULE.instance.exports.memory.buffer);
	}

	function setUint32(ptr, value) {
		mem().setUint32(ptr, value);
	}

	function setUint64(ptr, value) {
		mem().setBigUint64(ptr, BigInt(value));
	}

	(async () => {
		// Fetch the wasm file as an ArrayBuffer
		const res = await fetch('./merton');
		const buf = await res.arrayBuffer();

		// Create wasm instance (module) from the ArrayBuffer
		WASM_MODULE = await WebAssembly.instantiate(buf, {
			// Custom imports
			env: {
				// Audio
				MTY_AudioCreate: function () {},
				MTY_AudioDestroy: function () {},
				MTY_AudioPlay: function () {},
				MTY_AudioStop: function () {},
				MTY_AudioQueue: function () {},
				MTY_AudioIsPlaying: function () {},
				MTY_AudioGetQueuedFrames: function () {},

				// Window
				MTY_WindowPoll: function () {},
				MTY_WindowSetWindowed: function () {},
				MTY_WindowSetFullscreen: function () {},
				MTY_WindowGetRefreshRate: function () {
					return 60;
				},
				MTY_GLGetProcAddress: function () {},
				MTY_WindowIsFullscreen: function () {},
				MTY_WindowRenderQuad: function () {},
				MTY_WindowIsForeground: function () {},
				MTY_WindowGetDevice: function () {
					return 0;
				},
				MTY_WindowGetContext: function () {
					return 0;
				},
				MTY_WindowGetBackBuffer: function () {
					return 0;
				},
				MTY_WindowGetDPIScale: function () {
					return 1.0;
				},
				MTY_WindowPresent: function () {},
				MTY_WindowDestroy: function () {},
				MTY_WindowSetTitle: function () {},
				MTY_WindowCreate: function () {
					const body = document.querySelector('body');
					body.style.width = '100%';
					body.style.height = '100%';
					body.style.padding = 0;
					body.style.margin = 0;

					const canvas = document.createElement('canvas');
					document.body.appendChild(canvas);
					console.log('here');

					return false;
				},
			},

			// Current version of WASI we're compiling against, 'wasi_snapshot_preview1'
			wasi_snapshot_preview1: {
				args_get: function () {
					return 0;
				},
				args_sizes_get: function (argc, argv_buf_size) {
					setUint32(argc, 0);
					setUint32(argv_buf_size, 0);
					return 0;
				},

				// High resolution timestamp
				// id: 1 == CLOCK_MONOTONIC
				// precision: in nanoseconds?
				// time_out: buffer to write the 64-bit timestamp
				clock_time_get: function (id, precision, time_out) {
					setUint64(time_out, Math.trunc(performance.now() * 1000 * 1000));
					return 0;
				},
				fd_close: () => {console.log('fd_close');},
				fd_fdstat_get: () => {console.log('fd_fdstat_get');},
				fd_fdstat_set_flags: () => {console.log('fd_fdstat_set_flags');},
				fd_prestat_dir_name: function (fd, path, path_len) {
					return 28;
				},
				fd_prestat_get: function (fd, path) {
					return 8;
				},
				fd_read: () => {console.log('fd_read');},
				fd_readdir: () => {console.log('fd_readdir');},
				fd_seek: () => {console.log('fd_seek');},
				fd_write: function () {
					console.log('fd_write');
				},
				path_create_directory: () => {console.log('path_create_directory');},
				path_open: () => {console.log('path_open');},
				path_readlink: () => {console.log('path_readlink');},
				poll_oneoff: function (sin, sout, nsubscriptions, nevents) {
					return 0;
				},
				proc_exit: () => {console.log('proc_exit');},
			},
		});

		// Execute the '_start' entry point, this will fetch args and execute the 'main' function
		WASM_MODULE.instance.exports._start();
	})();
</script>
